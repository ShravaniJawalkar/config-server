// Jenkinsfile-linux

pipeline {
    agent any
     stages {
       stage('Checkout Code') {
            steps {
                git branch: 'master', url: 'https://github.com/ShravaniJawalkar/config-server.git'
            }
        }

        stage('Build') {
            steps {
                   sh 'chmod +x mvnw'
                sh './mvnw clean package'
            }
        }

        stage('Deploy') {
            steps {
                sshagent(credentials: ['ec2-ssh-key']) {
                    sh '''
                        # Escape the quotes so the remote shell executes the full command
                        ssh -o StrictHostKeyChecking=no ec2-user@ec2-13-232-81-205.ap-south-1.compute.amazonaws.com "pkill -f config-server-0.0.1-SNAPSHOT.jar" || true

                        # Copy the new JAR file to the EC2 instance.
                        scp -o StrictHostKeyChecking=no target/config-server-0.0.1-SNAPSHOT.jar \\
                        ec2-user@ec2-13-232-81-205.ap-south-1.compute.amazonaws.com:/home/ec2-user/app/
                         '''
                }
            }
        }
    }
}